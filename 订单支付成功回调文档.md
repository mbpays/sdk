# MBPay 支付链接支付成功后回调通知

本文档详细说明回调通知的相关文档。


## 回调通知

### 概述

当订单支付成功后，支付链接中提供的 `notify_url`，系统会向该地址发送异步回调通知。

### 回调时机

- 订单状态变为"支付成功"时立即触发
- 回调失败后，系统会在以下时间间隔重试：5s、5s、15s、30s、60s、120s、300s、600s、1200s、1800s、3600s、7200s
- 可在商户后台查看回调异常信息和状态

### 回调请求

#### 请求方式

```
POST {notify_url}
```

#### 请求头

```
Content-Type: application/x-www-form-urlencoded
```

#### 请求参数

回调请求以 `application/x-www-form-urlencoded` 格式发送，包含以下参数：

| 参数名 | 类型 | 说明 |
|--------|------|------|
| app_id | string | 商户的 App ID |
| order_no | string | 商户订单号 |
| platform_order_no | string | 平台订单号 |
| amount | int64 | 订单金额（分） |
| merchant_amount | int64 | 商户实收金额（分） |
| platform_fee | int64 | 平台手续费（分） |
| subject | string | 商品描述 |
| status | int64 | 订单状态（1=支付成功） |
| paid_at | string | 支付时间（格式：2006-01-02 15:04:05） |
| timestamp | int64 | 时间戳（Unix 时间戳，秒级） |
| sign | string | 签名值 |

#### 回调参数示例

```
app_id=your_app_id&order_no=ORD202501011200001234567890&platform_order_no=202501011200001234567890&amount=1000&merchant_amount=994&platform_fee=6&subject=购买VIP，1个月&status=1&paid_at=2025-01-01 12:00:00&timestamp=1704067200&sign=5f4dcc3b5aa765d61d8327deb882cf99...
```

### 签名验证

**重要：开发者收到回调请求时，必须验证签名，确保请求来自 MBPay 平台。**

#### 验证步骤

1. **获取所有参数**（排除 `sign` 字段）
2. **按 ASCII 升序排序**参数名
3. **拼接签名字符串**：`k1=v1&k2=v2&...&key=app_secret`
   - 格式：`参数名=参数值&参数名=参数值&...&key=app_secret`
   - 注意：最后追加 `&key=app_secret`，其中 `app_secret` 为商户的 App Secret
4. **SHA256 哈希**：对拼接后的字符串进行 SHA256 哈希计算
5. **转换为小写 hex**：将哈希结果转换为小写 hex 字符串
6. **对比签名**：将计算得到的签名与回调请求中的 `sign` 参数对比

#### 验证示例

假设收到以下回调参数：

```
app_id=your_app_id_123
order_no=ORD202501011200001234567890
platform_order_no=202501011200001234567890
amount=1000
merchant_amount=994
platform_fee=6
subject=购买VIP，1个月
status=1
paid_at=2025-01-01 12:00:00
timestamp=1704067200
sign=5f4dcc3b5aa765d61d8327deb882cf99...
```

App Secret 为：`your_app_secret_456`

**步骤 1：** 排除 `sign` 字段，获取参数列表

```
app_id, order_no, platform_order_no, amount, merchant_amount, platform_fee, subject, status, paid_at, timestamp
```

**步骤 2：** 按 ASCII 升序排序

```
amount, app_id, merchant_amount, order_no, paid_at, platform_fee, platform_order_no, status, subject, timestamp
```

**步骤 3：** 拼接签名字符串

```
amount=1000&app_id=your_app_id_123&merchant_amount=994&order_no=ORD202501011200001234567890&paid_at=2025-01-01 12:00:00&platform_fee=6&platform_order_no=202501011200001234567890&status=1&subject=购买VIP，1个月&timestamp=1704067200&key=your_app_secret_456
```

**步骤 4-5：** SHA256 哈希并转换为小写 hex

```
sign = SHA256(签名字符串) 的小写 hex
```

**步骤 6：** 对比签名

```python
if calculated_sign == received_sign:
    # 签名验证通过
    return True
else:
    # 签名验证失败，拒绝处理
    return False
```

### 回调响应

#### 成功响应

开发者验证签名通过后，**必须返回字符串 `"OK"`**（不包含引号，仅返回 OK 两个字符），不需要返回额外的数据信息。

**响应格式：**

```
OK
```

**HTTP 状态码：** `200 OK`

#### 失败响应

如果签名验证失败或处理失败，可以返回其他内容，系统会认为回调失败并进行重试。

### 回调注意事项

1. **必须验证签名**：收到回调请求后，必须验证签名，确保请求来自 MBPay 平台
2. **幂等性处理**：同一个订单可能收到多次回调，需要实现幂等性处理，避免重复处理
3. **快速响应**：回调处理应尽可能快速，建议在 5 秒内返回响应
4. **返回格式**：验证通过后，必须返回字符串 `"OK"`，不要返回 JSON 或其他格式
5. **错误处理**：如果处理失败，可以返回错误信息，系统会进行重试
6. **日志记录**：建议记录回调请求和响应，便于排查问题
7. **HTTPS 回调**：`notify_url` 建议使用 HTTPS 协议，确保数据传输安全

---

## 注意事项

1. **订单号唯一性**：`order_no` 必须在商户维度内唯一
2. **过期时间**：建议设置合理的过期时间（如 15-30 分钟）
3. **签名安全**：确保 App Secret 保密，不要暴露在客户端代码中
4. **HTTPS 回调**：`notify_url` 建议使用 HTTPS 协议
5. **错误处理**：妥善处理生成失败的情况，记录错误日志
6. **测试环境**：在测试环境充分测试后再上线

---

**文档版本**: v1.0  
**最后更新**: 2025-11-11

